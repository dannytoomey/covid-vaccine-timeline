---
title: "Plots"
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=file.path(here::here(), "docs", "plots_report")) })
output: 
  pdf_document:
    keep_tex: true
header-includes:
  - |
    ```{=latex}
    ```
---

```{r packages, eval=FALSE, include=FALSE}
install.packages("orderly")
install.packages("knitr")
install.packages("here")
install.packages("dplyr")
install.packages("ggplot2")

library(orderly)
library(knitr)
library(here)
library(dplyr)
library(ggplot2)
```

```{r setup, include=FALSE}
root_path = here::here()
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
knitr::opts_knit$set(root.dir = root_path)
setwd(root_path)
```


```{r get-paths}
stage = "generate_production_counterfactual"
id = orderly::orderly_latest(stage)
prod_cfact_path = paste0(root_path, "/archive/", stage, "/", id)

stage = "generate_vaccine_counterfactual"
id = orderly::orderly_latest(stage)
vacc_cfact_path = paste0(root_path, "/archive/", stage, "/", id)

stage = "generate_counterfactuals"
id = orderly::orderly_latest(stage)
cfacts_path = paste0(root_path, "/archive/", stage, "/", id)

stage = "deaths_averted_plot_timeline"
id = orderly::orderly_latest(stage)
deaths_av_path = paste0(root_path, "/archive/", stage, "/", id)
```

```{r cumul-vacc-cfacts, fig.align="center", fig.cap=c("DJ4 Cumulative vaccine counterfactuals")}
baseline = readRDS(paste0(vacc_cfact_path, "/counterfactual_timelines/owid_raw.Rds"))
sooner_30 = readRDS(paste0(vacc_cfact_path, "/counterfactual_timelines/30_days_sooner.Rds"))
sooner_60 = readRDS(paste0(vacc_cfact_path, "/counterfactual_timelines/60_days_sooner.Rds"))
sooner_90 = readRDS(paste0(vacc_cfact_path, "/counterfactual_timelines/90_days_sooner.Rds"))

counterfactuals = bind_rows(baseline, sooner_30, sooner_60, sooner_90)

dj4 = ggplot() +
  geom_line(data = counterfactuals,
            aes(x = as.Date(date),
                y = total_vacc,
                color = as.character(shifted_by))) +
  facet_wrap(~country, ncol = 2, scales = "free_y") +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) +
  labs(x = "Date",
       y = "Cumulative vaccinations",
       color = "Vaccinations start sooner by:") +
  theme(aspect.ratio = 1)

plot(dj4)
```

### DJ5 Table
\input{`r paste0(deaths_av_path, "/counterfactuals_table.tex")`}

```{r daily-deaths, fig.align="center", fig.cap=c("DJ6 Daily deaths per scenario")}
knitr::include_graphics(paste0(deaths_av_path, "/all_tsplot.png"))
```

```{r prod-assumptions, fig.align="center", fig.cap=c("DJ9 Vaccine production assumptions")}
knitr::include_graphics(paste0(prod_cfact_path, "/vaccine_production.png"))
```

```{r GBR-prod-cap, fig.align="center", fig.cap=c("DJ10 UK limits from production")}
knitr::include_graphics(paste0(vacc_cfact_path, "/shifts_plots/GBR.png"))
```
```{r USA-prod-cap, fig.align="center", fig.cap=c("DJ10 USA limits from production")}
knitr::include_graphics(paste0(vacc_cfact_path, "/shifts_plots/USA.png"))
```

